<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Flutter实现Git权限分配工具之旅 | LiuYang's blog</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="前端, 程序员, Android, Flutter, Kotlin, 全栈开发, node.js, javascript"><meta name="description" content="经验总结和日常学习的个人博客。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://handsomeliuyang.github.io/2018/10/30/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/index.html"><link rel="icon" type="image/png" href="/hexo-img/favicon.png" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="刘阳" type="application/atom+xml"><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/hexo-img/loading.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="刘阳" alt="刘阳"><img src="/hexo-img/favicon.png" alt="刘阳"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/hexo-img/default_cover.png" alt="Flutter实现Git权限分配工具之旅"></div><header class="post__info"><h1 class="post__title">Flutter实现Git权限分配工具之旅</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a target="_blank" rel="noopener" href="https://github.com/handsomeliuyang">liuyang</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-10-30</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li><li class="mark__item"><a href="/tags/Flutter/">Flutter</a></li></ul></div></div></header><div class="post__content"><h1 id="Flutter初见"><a href="#Flutter初见" class="headerlink" title="Flutter初见"></a>Flutter初见</h1><blockquote><p>Flutter is a mobile app SDK for building high-performance, high-fidelity, apps for iOS and Android, from a single codebase.</p></blockquote><p>Flutter 是一款移动应用程序 SDK，致力于使用一套代码来构建高性能、高保真的 iOS 和 Android 应用程序。</p><p><strong>Flutter的优势：</strong></p><ol><li>开发效率高：<ol><li>一套代码开发 iOS 和 Android</li><li>热加载（hot reload）</li></ol></li><li>创建美观，高度定制的用户体验<ol><li>Material Design 和 Cupertino （iOS 风格）Widget</li><li>实现定制，美观，品牌驱动的设计，而不受 OEM Widget 集的限制</li></ol></li></ol><p><strong>框架结构（Architecture）</strong><br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/old-architecture.png"></p><p><img src="https://flutter.io/images/whatisflutter/diagram-layercake.svg"></p><ol><li><strong><a target="_blank" rel="noopener" href="https://skia.org/">Skia</a>：</strong>开源的2d图形库。其已作为Chrome, Chrome OS, Android, Firefox, Firefox OS等其他众多产品的图形引擎，支持平台还包括Windows,macOS,iOS8+,Ubuntu14.04+等。</li><li><strong>Dart：</strong><ol><li>debug：JIT(Just In Time)编译，运行时分析、编译，运行较慢。Hot Reload基于JIT运行</li><li>release：AOT(Ahead Of Time)编译，生成了原生的arm代码，开发期间较慢，但运行期间快</li><li>一切都是对象，甚至数字，函数，和null都是对象</li><li>默认publick，通过加(_)标记为私有</li><li>单线程，没有锁的概念</li></ol></li><li><strong>Text：</strong>文本渲染</li></ol><p><strong>Dart的线程模型</strong></p><p>Flutter与Android一样，通过Main线程和消息循环实现UI绘制操作与UI事件，如下所示：<br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.png"></p><p>Dart的不同点：</p><ol><li>Dart是单线程执行，通过Future来实现异步编程，只是把任务暂时放在消息队列里，本质还是单线程执行，与javascript类型</li><li>两个消息队列：event队列和microtask队列</li></ol><p>单线程带来的问题：单某个任务执行时间过长，超过16ms时，会导致丢帧，给用户的感觉就是卡顿，React借助requestIdleCallback Api实现了卡顿优化，<a href="https://handsomeliuyang.github.io/2018/08/07/DiyReact%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/">详情请参考</a></p><p>Dart解决这个问题的方案：通过<a target="_blank" rel="noopener" href="https://docs.flutter.io/flutter/dart-isolate/Isolate-class.html">Isolate</a>真正意义上创建线程，但此线程与java里的线程不一样：isolates之间不会共享内存，更像进程，通过传递message来进行交流，<a target="_blank" rel="noopener" href="https://flutter.io/docs/cookbook/networking/background-parsing">Demo</a></p><p><strong>一切都是Widget</strong></p><p>Widgets是Flutter应用程序用户界面的基础构建模块，Widgets包含了views，view controllers，layouts等等能力。</p><p>Flutter提供了很多基组Widgets，但这些Widgets有一个与Android最大的不同点：每个Widget的能力很单一，如Text Widget，没有width, height, padding,color等等属性，需要借助其他Widget。</p><p><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/widgets%E7%9A%84%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6.png"></p><p>更多细节请查看：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9e6c470ea5bf">Flutter快速上车之Widget</a></p><p><strong>StatelessWidget &amp; StatefulWidget</strong></p><p>Flutter的widget分为无状态和有状态，如下所示：<br><img src="http://doc.flutter-dev.cn/images/whatisflutter/diagram-widgetclass.svg"></p><p>如何选择？下面是我的一些经验：</p><ol><li>包含TextField的widget — StatefulWidget</li><li>用户交互时，产出的数据，如点击计数<ol><li>局部数据 — StatefulWidget</li><li>全局数据（store存储） — StatelessWidget</li></ol></li><li>默认为StatelessWidget</li></ol><p><strong>Widget，Element，RenderObject</strong></p><p>Flutter里的Widgets，Elements, RenderObject三要素与React中的Element，Instance&#x2F;Fiber, Dom有点类似</p><ol><li>Widgets：widget tree，只是属性集合，需要被绘制的属性集合，每次build，都是新对象，所以属性都要用final修饰</li><li>Elements：element tree，concrete widget tree，diff操作，每次build，不会重新构建，进行diff和update</li><li>RenderObject：真正负责layout, rendering等等操作，一般是由element创建</li></ol><p><strong>Flutter的性能</strong></p><p>Flutter性能要高的原因：</p><ol><li>debug为字节码，release为机器码</li><li>不依赖OEM widgets</li><li>没有bridge</li></ol><blockquote><p><strong>Native View:</strong><br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/native-view.png"></p></blockquote><blockquote><p><strong>Hybrid:</strong><br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/hybrid.png"></p></blockquote><blockquote><p><strong>ReactNative:</strong><br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/reactnative.png"></p></blockquote><blockquote><p><strong>Flutter</strong><br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/flutter.png"></p></blockquote><p><font color="#ff0000">注意：以上只是从实现角度分析，在机器性能好的情况下，实际差距不大</font></p><h1 id="Git权限分配工具简介"><a href="#Git权限分配工具简介" class="headerlink" title="Git权限分配工具简介"></a>Git权限分配工具简介</h1><p>为不同类型的角色批量分配Git权限的工具，整体效果如下：</p><iframe height="520" width="100%" src="/2018/10/30/Flutter实现Git权限分配工具之旅/flutter-igit.gif" frameborder="0" allowfullscreen></iframe><p>源码下载地址：<a target="_blank" rel="noopener" href="https://github.com/handsomeliuyang/flutter-igit">https://github.com/handsomeliuyang/flutter-igit</a></p><h2 id="框架结构"><a href="#框架结构" class="headerlink" title="框架结构"></a>框架结构</h2><p><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/%E6%A1%86%E6%9E%B6.png"></p><ol><li>pubspec.yaml：与package.json&#x2F;build.grale类似，用于配置程序的信息，如下所示：<br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/pubspec.yaml.png"></li><li>assets：用于存放内置图片与资源，自建目录可修改</li><li>lib：src目录，按功能模块分为：<ol><li>main.dart&#x2F;main_dev.dart：程序的入口文件，与c语言类似，dart程序的入口为main()函数，main_dev.dart的区别是使用DevToolsStore，用于查看store与action</li><li>App.dart：最外层的配置，如下所示：<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> StoreProvider( <span class="comment">// 使用Redux的要求</span></span><br><span class="line">        store: widget.store,</span><br><span class="line">        child: <span class="keyword">new</span> MaterialApp( <span class="comment">// 使用Material要求</span></span><br><span class="line">            title: <span class="string">&#x27;Flutter igit&#x27;</span>, </span><br><span class="line">            theme: <span class="keyword">new</span> ThemeData( <span class="comment">// 全局样式</span></span><br><span class="line">                primaryColor: <span class="keyword">const</span> Color(<span class="number">0xFF1C306D</span>),</span><br><span class="line">                accentColor: <span class="keyword">const</span> Color(<span class="number">0xFFFFAD32</span>),</span><br><span class="line">            ),</span><br><span class="line">            home: MainPage(</span><br><span class="line">                devDrawerBuilder: widget.devDrawerBuilder</span><br><span class="line">            ),</span><br><span class="line">        ),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>按功能划分目录：models, networking, redux, ui, utils</li></ol></li></ol><h3 id="redux"><a href="#redux" class="headerlink" title="redux"></a>redux</h3><p>redux的结构非常简单，如下所示：<br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/redux_architecture.png"></p><p>由于Flutter是一个类似MVVM框架，所以通过StoreConnector实现数据监听，如下所示：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> StoreConnector&lt;AppState, DrawListViewModel&gt; (</span><br><span class="line">        distinct: <span class="keyword">true</span>,</span><br><span class="line">        converter: (store) =&gt; DrawListViewModel.fromStore(store),</span><br><span class="line">        builder: (context, viewModel)&#123;</span><br><span class="line">            <span class="keyword">return</span> DrawListContent(</span><br><span class="line">                header: <span class="keyword">this</span>.header,</span><br><span class="line">                viewModel: viewModel,</span><br><span class="line">            );</span><br><span class="line">        &#125;,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Flutter里，应用了Redux后的实现结构为：<br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/flutter-redux-apply.png"></p><p>Redux是全局单例，应用的功能模块很多，所以redux的目录与state按功能模块的划分更加合适，如下所示：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppState</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> TradelineState tradelineState;</span><br><span class="line">    <span class="keyword">final</span> PermissionState permissionState;</span><br><span class="line">    <span class="keyword">final</span> ProjectState projectState;</span><br><span class="line"></span><br><span class="line">    AppState(&#123;</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.tradelineState,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.permissionState,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.projectState</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> initial() &#123;</span><br><span class="line">        <span class="keyword">return</span> AppState(</span><br><span class="line">            tradelineState: TradelineState.initial(),</span><br><span class="line">            permissionState: PermissionState.initial(),</span><br><span class="line">            projectState: ProjectState.initial()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/redux-catalog.png"></p><h3 id="network"><a href="#network" class="headerlink" title="network"></a>network</h3><p>flutter的http请求很简单，主要是使用两个Api：http，Uri，如下所示：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">List</span>&lt;GitProject&gt;&gt; getGroups(<span class="built_in">int</span> page, <span class="built_in">String</span> search) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">Uri</span> uri = <span class="built_in">Uri</span>.http(</span><br><span class="line">        AUTHORITY,</span><br><span class="line">        <span class="string">&#x27;<span class="subst">$&#123;FIXED_PATH&#125;</span>/groups&#x27;</span>,</span><br><span class="line">        &lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;&#123;</span><br><span class="line">            <span class="string">&#x27;private_token&#x27;</span>: Config.LIUYANG_TOKEN,</span><br><span class="line">            <span class="string">&#x27;per_page&#x27;</span>: PER_PAGE.toString(),</span><br><span class="line">            <span class="string">&#x27;all_available&#x27;</span>: <span class="string">&#x27;true&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;page&#x27;</span>:<span class="string">&#x27;<span class="subst">$&#123;page&#125;</span>&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;search&#x27;</span>:<span class="string">&#x27;com.wuba&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> response = <span class="keyword">await</span> http.<span class="keyword">get</span>(uri.toString());</span><br><span class="line">    <span class="keyword">final</span> jsonResponse = json.decode(response.body);</span><br><span class="line"></span><br><span class="line">    debugPrint(<span class="string">&#x27;liuyang <span class="subst">$&#123;jsonResponse&#125;</span>&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(response.statusCode == <span class="number">200</span>)&#123;</span><br><span class="line">        <span class="built_in">List</span>&lt;GitProject&gt; groups = <span class="built_in">List</span>&lt;GitProject&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i=<span class="number">0</span>; i&lt;jsonResponse.length; i++)&#123;</span><br><span class="line">            groups.add(GitProject.fromJson(jsonResponse[i], ProjectType.group));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> groups;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> Exception(<span class="string">&#x27;Failed <span class="subst">$&#123;response.statusCode&#125;</span> <span class="subst">$&#123;response.body&#125;</span>&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：</strong></p><ol><li>上面是通过async,Future实现异步操作，但此异步并不是真正的开异步线程，只是把任务放在队列里，延迟执行而已，应该使用isolate实现真正的异步执行</li><li>面向对象编程，每个Model里，都有两个Api：fromJson()，toJson()</li></ol><h2 id="MainPage"><a href="#MainPage" class="headerlink" title="MainPage"></a>MainPage</h2><p>整体效果：<br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/mainpage.png"><br>关键点：</p><ol><li>此框架页包含：AppBar，Drawer，DevDrawer，PermissionPage</li><li>此框架默认应该是StatelessWidget，但由于AppBar的title需要动态拼接，导致只能改为StatefulWidget，如下：<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyPageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MainPage</span>&gt; </span>&#123;</span><br><span class="line">    Widget _buildTitle(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> StoreConnector&lt;AppState, Tradeline&gt;(</span><br><span class="line">            distinct: <span class="keyword">true</span>,</span><br><span class="line">            converter: (store) =&gt; store.state.tradelineState.current,</span><br><span class="line">            builder: (BuildContext context, Tradeline currentTradeline) &#123;</span><br><span class="line">                <span class="keyword">return</span> Text(</span><br><span class="line">                    <span class="string">&#x27;分配 <span class="subst">$&#123;currentTradeline?.name ?? <span class="string">&#x27;&#x27;</span>&#125;</span> 的igit权限&#x27;</span></span><br><span class="line">                );</span><br><span class="line">            &#125;,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">            appBar: <span class="keyword">new</span> AppBar(title: _buildTitle(context)),</span><br><span class="line">            drawer: Drawer(</span><br><span class="line">                child: DrawList(</span><br><span class="line">                    header: DrawListHeader()</span><br><span class="line">                ),</span><br><span class="line">            ),</span><br><span class="line">            endDrawer: widget.devDrawerBuilder != <span class="keyword">null</span> ? widget.devDrawerBuilder(context) : <span class="keyword">null</span>,</span><br><span class="line">            body: PermissionPage(),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>dart里创建对象时，new关键字不是必需的，如下：<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Shape shape = <span class="keyword">new</span> Shape();</span><br><span class="line">Shape shape1 = Shape();</span><br></pre></td></tr></table></figure>在build时，个人感觉省略掉new关键字，可读性更强</li></ol><h2 id="Drawer"><a href="#Drawer" class="headerlink" title="Drawer"></a>Drawer</h2><p>效果如下：<br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/drawer.png"></p><p>功能比较简单，思路如下：</p><ol><li>通过StoreConnector，获取并监听Store</li><li>构建ListView</li></ol><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawList</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Widget header;</span><br><span class="line"></span><br><span class="line">    DrawList(&#123;</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.header</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> StoreConnector&lt;AppState, DrawListViewModel&gt; (</span><br><span class="line">            distinct: <span class="keyword">true</span>,</span><br><span class="line">            converter: (store) =&gt; DrawListViewModel.fromStore(store),</span><br><span class="line">            builder: (context, viewModel)&#123;</span><br><span class="line">                <span class="keyword">return</span> DrawListContent(</span><br><span class="line">                    header: <span class="keyword">this</span>.header,</span><br><span class="line">                    viewModel: viewModel,</span><br><span class="line">                );</span><br><span class="line">            &#125;,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawListContent</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Widget header;</span><br><span class="line">    <span class="keyword">final</span> DrawListViewModel viewModel;</span><br><span class="line"></span><br><span class="line">    DrawListContent(&#123;</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.header,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.viewModel</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> ListView.builder(</span><br><span class="line">            itemCount: <span class="keyword">this</span>.viewModel.tradelines.length + <span class="number">1</span>,</span><br><span class="line">            itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">                <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.header;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Tradeline tradeline = <span class="keyword">this</span>.viewModel.tradelines[index - <span class="number">1</span>];</span><br><span class="line">                <span class="built_in">bool</span> isSelected = <span class="keyword">this</span>.viewModel.currentTradeline.name ==</span><br><span class="line">                    tradeline.name;</span><br><span class="line">                <span class="keyword">var</span> backgroundColor = isSelected</span><br><span class="line">                    ? <span class="keyword">const</span> Color(<span class="number">0xFFEEEEEE</span>)</span><br><span class="line">                    : Theme</span><br><span class="line">                    .of(context)</span><br><span class="line">                    .canvasColor;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> Material(</span><br><span class="line">                    color: backgroundColor,</span><br><span class="line">                    child: ListTile(</span><br><span class="line">                        onTap: () &#123;</span><br><span class="line">                            viewModel.changeCurrentTradeline(tradeline);</span><br><span class="line">                            Navigator.pop(context);</span><br><span class="line">                        &#125;,</span><br><span class="line">                        selected: isSelected,</span><br><span class="line">                        title: Text(tradeline.name),</span><br><span class="line">                    ),</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关键点：</p><ol><li>ListTile的属性有限，设置Item的背景通过Material Widget，也可以通过Container Widget</li><li>ListView没有header的概念，都是item</li><li>ListView没有分隔线的Api，分隔线是由Item实现，通过ListTile.divideTiles()实现，其内部是通过DecoratedBox Widget实现</li><li>Navigator栈：Drawer，Dialog，Route都由Navigator栈管理，所以如下操作都是出栈操作Navigator.pop(context)：<ol><li>dismiss drawer</li><li>dismiss dialog</li><li>Back</li></ol></li></ol><h2 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h2><p>Panel效果的源码来自：flutter_gallery里的Expansion panels例子，个人学习新技术的过程：</p><ol><li>看官方的文档</li><li>运行官方demo，思考如何实现，对照源码的实现</li></ol><p>具体的代码，可通过下载源码查看，这里重点讲一下Flutter的生命周期函数，在Flutter里，StatelessWidget和StatefulWidget没有生命周期，因为其是不可变的，只有State才有生命周期，如下所示：<br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/state-lifecycle.png"></p><p>当数据变化时，StatelessWidget与StatefulWidget每次都会创建新的对象，并执行build()函数，State会被复用，造成flutter程序的如下特点：</p><ol><li>StatelessWidget, StatefulWidget里的成员变量都是final的，可以理解为React里的props</li><li>State里的成员变量可以理解为React里的state，即为局部变量（Store里的为全局变量）</li><li>State的initState()只执行一次，如果成员变量需要依据props而修改，可以在didUpdateWidget()里更新</li><li>修改State的成员变量时，如果希望界面需要同步修改，需要在setState()里修改，如下所示：— <font color="#ff0000">大家可以对比下与React的setState()有什么区别？</font><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setState(() &#123;</span><br><span class="line">    item.isExpanded = <span class="keyword">false</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ol><p>如下所示：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PermissionContent</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;GitProject&gt; projects;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;GitUser&gt; users;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> addGitProject;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> deleteGitProject;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> getUserIdByName;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> deleteGitUser;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> allocationPermission;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> PermissionContent(&#123;</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.projects,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.users,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.addGitProject,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.deleteGitProject,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.getUserIdByName,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.deleteGitUser,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.allocationPermission</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    _PermissionContentState createState() =&gt; _PermissionContentState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_PermissionContentState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">PermissionContent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; ACCESS_LEVEL = &#123;...&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">List</span>&lt;PanelItem&gt; _panelItems;</span><br><span class="line">    PanelItem _userPanelItem;</span><br><span class="line">    PanelItem _rolePanelItem;</span><br><span class="line">    PanelItem _projectPanelItem;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> initState() &#123;</span><br><span class="line">        <span class="keyword">super</span>.initState();</span><br><span class="line">        _userPanelItem = _initUserPanelItem();</span><br><span class="line">        _rolePanelItem = _initRolePanelItem();</span><br><span class="line">        _projectPanelItem = _initProjectPanelItem();</span><br><span class="line">        _panelItems = &lt;PanelItem&gt;[</span><br><span class="line">            _userPanelItem,</span><br><span class="line">            _rolePanelItem,</span><br><span class="line">            _projectPanelItem</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> didUpdateWidget(PermissionContent oldWidget) &#123;</span><br><span class="line">        <span class="keyword">super</span>.didUpdateWidget(oldWidget);</span><br><span class="line">        <span class="comment">// 更新数据</span></span><br><span class="line">        _projectPanelItem.value = widget.projects;</span><br><span class="line">        _userPanelItem.value = widget.users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> _navigatorProjectPage(BuildContext context) <span class="keyword">async</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    PanelItem _initUserPanelItem() &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    PanelItem _initRolePanelItem() &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    PanelItem _initProjectPanelItem() &#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>** 交互反馈 **</p><p>除了通过Widget构建界面外，有时我们还需要给用户交互反馈：</p><ol><li>Toasts&#x2F;Snackbars：仅信息反馈，定时消失，不进Navigator栈<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Scaffold.of(context).showSnackBar(<span class="keyword">new</span> SnackBar(</span><br><span class="line">    content: <span class="keyword">new</span> Text(<span class="string">&quot;权限分配成功&quot;</span>),</span><br><span class="line">));</span><br></pre></td></tr></table></figure></li><li>Dialog：信息反馈，有进一步交互，Natvigator栈管理<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// show:</span></span><br><span class="line">showDialog(</span><br><span class="line">    context: context,</span><br><span class="line">    barrierDismissible: <span class="keyword">false</span>,</span><br><span class="line">    builder: (BuildContext context)&#123;</span><br><span class="line">        <span class="keyword">return</span> Dialog(</span><br><span class="line">            child: Row(</span><br><span class="line">                mainAxisSize: MainAxisSize.min,</span><br><span class="line">                children: [</span><br><span class="line">                    CircularProgressIndicator(),</span><br><span class="line">                    Text(<span class="string">&quot;Loading&quot;</span>),</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// Dismiss:</span></span><br><span class="line">Navigator.pop(context);</span><br></pre></td></tr></table></figure></li></ol><p>Dialog仅仅只是modal，无法通过props来控制显示与消失，只能监听局部变量state或全局变量store来控制show与dismiss，分配权限的过程的代码如下：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Completer对象</span></span><br><span class="line">Completer&lt;<span class="built_in">bool</span>&gt; completer = Completer&lt;<span class="built_in">bool</span>&gt;();</span><br><span class="line"><span class="comment">// 发送action，通过igit的Api分配权限</span></span><br><span class="line">widget.allocationPermission(completer, users, level, projects);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同时显示LoadingDialog</span></span><br><span class="line">showDialog(</span><br><span class="line">    context: context,</span><br><span class="line">    barrierDismissible: <span class="keyword">false</span>,</span><br><span class="line">    builder: (BuildContext context)&#123;</span><br><span class="line">        <span class="keyword">return</span> Dialog(</span><br><span class="line">            child: Row(</span><br><span class="line">                mainAxisSize: MainAxisSize.min,</span><br><span class="line">                children: [</span><br><span class="line">                    CircularProgressIndicator(),</span><br><span class="line">                    Text(<span class="string">&quot;Loading&quot;</span>),</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 监听成功与失败，并显示不同Toasts</span></span><br><span class="line">completer.future.then((user)&#123;</span><br><span class="line">    Navigator.pop(context);</span><br><span class="line"></span><br><span class="line">    Scaffold.of(context).showSnackBar(<span class="keyword">new</span> SnackBar(</span><br><span class="line">        content: <span class="keyword">new</span> Text(<span class="string">&quot;权限分配成功&quot;</span>),</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">&#125;, onError: (e)&#123;</span><br><span class="line">    Navigator.pop(context);</span><br><span class="line"></span><br><span class="line">    Scaffold.of(context).showSnackBar(<span class="keyword">new</span> SnackBar(</span><br><span class="line">        content: <span class="keyword">new</span> Text(<span class="string">&quot;权限分配失败 <span class="subst">$&#123;e&#125;</span>&quot;</span>),</span><br><span class="line">    ));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><p>效果如下：<br><img src="/../../hexo-img/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/project.png"></p><p>详细细节请查看代码，重点分享其中几个关键点</p><p><strong>LoadingView</strong><br>除静态页面外，所有的页面都有一个共同的加载流程：加载中…，失败&#x2F;成功。统一实现LoadingView，如下所示：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectListWrap</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ProjectListViewModel projectListViewModel;</span><br><span class="line"></span><br><span class="line">    ProjectListWrap(&#123;</span><br><span class="line">        <span class="keyword">this</span>.projectListViewModel</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> LoadingView(</span><br><span class="line">            status: projectListViewModel.status,</span><br><span class="line">            loadingContent: PlatformAdaptiveProgressIndicator(),</span><br><span class="line">            errorContent: ErrorView(</span><br><span class="line">                description: <span class="string">&#x27;加载出错&#x27;</span>,</span><br><span class="line">                onRetry: projectListViewModel.refreshProjects,</span><br><span class="line">            ),</span><br><span class="line">            successContent: ProjectListContent(</span><br><span class="line">                projects: projectListViewModel.projects,</span><br><span class="line">                nextState: projectListViewModel.nextStatus,</span><br><span class="line">                currentPage: projectListViewModel.currentPage,</span><br><span class="line">                hasNext: projectListViewModel.hasNext,</span><br><span class="line">                refreshProjects: projectListViewModel.refreshProjects,</span><br><span class="line">                fetchNextProjects: projectListViewModel.fetchNextProjects,</span><br><span class="line">            ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>下滑加载下一页</strong><br>列表数据很多，通过滑动动态加载下一页数据，监听的方式与Android的类似，通过监听其滑动位置，同时由于滑动是有状态的，所以要使用StatefulWidget，如下所示：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectListContent</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;GitProject&gt; projects;</span><br><span class="line">    <span class="keyword">final</span> LoadingStatus nextState;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> currentPage;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">bool</span> hasNext;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> refreshProjects;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> fetchNextProjects;</span><br><span class="line"></span><br><span class="line">    ProjectListContent(&#123;</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.projects,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.nextState,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.currentPage,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.hasNext,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.refreshProjects,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.fetchNextProjects</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    State&lt;StatefulWidget&gt; createState() =&gt; _ProjectListContentState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ProjectListContentState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ProjectListContent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ScrollController scrollController = ScrollController();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> initState() &#123;</span><br><span class="line">        <span class="keyword">super</span>.initState();</span><br><span class="line"></span><br><span class="line">        scrollController.addListener(_scrollListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">        scrollController.removeListener(_scrollListener);</span><br><span class="line"></span><br><span class="line">        scrollController.dispose();</span><br><span class="line">        <span class="keyword">super</span>.dispose();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> _scrollListener() &#123;</span><br><span class="line">        <span class="keyword">if</span> (scrollController.position.extentAfter &lt; <span class="number">64</span> * <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(widget.nextState == LoadingStatus.success &amp;&amp; widget.hasNext)&#123;</span><br><span class="line">                widget.fetchNextProjects(widget.currentPage + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    Widget _nextStateToText() &#123;</span><br><span class="line">        <span class="keyword">if</span>(!widget.hasNext) &#123;</span><br><span class="line">            <span class="keyword">return</span> Text(<span class="string">&#x27;加载成功，已无下一页&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(widget.nextState == LoadingStatus.error)&#123;</span><br><span class="line">            <span class="keyword">return</span> Text(<span class="string">&#x27;加载失败，滑动重新加载&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Text(<span class="string">&#x27;加载中...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Flutter是不同于ReactNative的跨端解决方案，是以一套代码实现高开发效率与高性能为目标，没有ReactNative的bridge，同时通过Dart解决javascript开发效率问题。</p><p>现在Flutter比较ReactNative的最大问题是：release下不支持”hot update”，官方的解释如下：</p><blockquote><p>Often people ask if Flutter supports “code push” or “hot update” or other similar names for pushing out-of-store updates to apps.</p><p>Currently we do not offer such a solution out of the box, but the primary blockers are not technological. Flutter supports just in time (JIT) or interpreter based execution on both Android and iOS devices. Currently we remove these libraries during –release builds, however we could easily include them.</p><p>The primary blockers to this feature resolve around current quirks of the iOS ecosystem which may require apps to use JavaScript for this kind of over-the-air-updates functionality. Thankfully Dart supports compiling to JavaScript and so one could imagine several ways in which one compile parts of ones application to JavaScript instead of Dart and thus allows replacement of or augmentation with those parts in deployed binaries.</p><p>This bug tracks adding some supported solution like this. I’ll dupe all the other reports here.</p><p>简单翻译：Flutter不支持release下的hot update，不是由于技术原因，而是iOS系统只支持javaScript实现无线更新功能，由于Dart可以转换为Javasript代码，所以有一种可能性：程序的一部分使用javascript，而不是dart，再通过动态下载这部分javascript代码，实现hot update。</p></blockquote><p>Flutter是否会成为主流的跨端解决方案，主要原因不在于其高的开发效率与高性能，主要是看Fuchsia操作系统的覆盖程序，如果Fuchsia能成为主流的物联网与Android设备的主流系统，Flutter才能真正成为主流。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a target="_blank" rel="noopener" href="https://flutter.io/technical-overview/">Technical Overview</a></li><li><a target="_blank" rel="noopener" href="https://medium.com/@nhancv/why-i-move-to-flutter-34c4005b96ef">Why I move to Flutter</a></li><li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7549b63a72d7">Dart与消息循环机制[翻译]</a></li><li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9e6c470ea5bf">Flutter快速上车之Widget</a></li><li><a target="_blank" rel="noopener" href="https://medium.com/flutter-community/flutter-what-are-widgets-renderobjects-and-elements-630a57d05208">Flutter, what are Widgets, RenderObjects and Elements?</a></li><li><a target="_blank" rel="noopener" href="https://blog.novoda.com/introduction-to-redux-in-flutter/">Introduction to Redux in Flutter</a></li><li><a target="_blank" rel="noopener" href="https://flutterbyexample.com/user-feedback-toasts-snackbars/">User Feedback: Toasts &#x2F; Snackbars</a></li><li><a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/issues/14330">Code Push &#x2F; Hot Update &#x2F; out of band updates</a></li></ol><div class="post-announce">感谢您的阅读，本文由 <a href="https://handsomeliuyang.github.io">刘阳</a> 版权所有。如若转载，请注明出处：刘阳（<a href="https://handsomeliuyang.github.io/2018/10/30/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/">https://handsomeliuyang.github.io/2018/10/30/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2018/08/07/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/DiyReact%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/" title="DiyReact学习之路"><i class="iconfont icon-prev"></i>DiyReact学习之路</a></div><div class="post__prev post__prev--right"><a href="/2018/12/03/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/LeetCode%E4%B9%8BMedian%20of%20Two%20Sorted%20Arrays/" title="LeetCode之Median of Two Sorted Arrays">LeetCode之Median of Two Sorted Arrays<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">经验总结和日常学习的个人博客。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/">经验总结</a><span class="block-list-count">32</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/">日常学习</a><span class="block-list-count">29</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%96%87%E7%AB%A0%E8%BD%AC%E5%8F%91/">文章转发</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2023/10/08/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/Android%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9AAndroid%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86/" title="Android内核学习笔记：Android进程\线程管理"><div class="item__cover"><img src="/hexo-img/default_cover.png" alt="Android内核学习笔记：Android进程\线程管理"></div><div class="item__info"><h3 class="item__title">Android内核学习笔记：Android进程\线程管理</h3><span class="item__text">2023-10-08</span></div></a></li><li class="latest-post-item"><a href="/2023/08/08/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/ASM%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/" title="ASM 学习心得"><div class="item__cover"><img src="/hexo-img/default_cover.png" alt="ASM 学习心得"></div><div class="item__info"><h3 class="item__title">ASM 学习心得</h3><span class="item__text">2023-08-08</span></div></a></li><li class="latest-post-item"><a href="/2023/02/22/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/App%E7%9A%84Repo%E5%A4%9A%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86/" title="App的Repo多仓库管理"><div class="item__cover"><img src="/hexo-img/default_cover.png" alt="App的Repo多仓库管理"></div><div class="item__info"><h3 class="item__title">App的Repo多仓库管理</h3><span class="item__text">2023-02-22</span></div></a></li><li class="latest-post-item"><a href="/2022/11/02/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/%E4%BB%8E%E5%BC%80%E5%8F%91%E8%80%85%E8%A7%92%E5%BA%A6%E6%80%9D%E8%80%83%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%9A%84%E4%BB%B7%E5%80%BC/" title="从开发者角度思考单元测试的价值"><div class="item__cover"><img src="/hexo-img/default_cover.png" alt="从开发者角度思考单元测试的价值"></div><div class="item__info"><h3 class="item__title">从开发者角度思考单元测试的价值</h3><span class="item__text">2022-11-02</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/AOP/">AOP</a></li><li class="tag-item"><a class="tag-link" href="/tags/ASM/">ASM</a></li><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Android%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">Android内核学习笔记</a></li><li class="tag-item"><a class="tag-link" href="/tags/Dart/">Dart</a></li><li class="tag-item"><a class="tag-link" href="/tags/Flutter/">Flutter</a></li><li class="tag-item"><a class="tag-link" href="/tags/Gradle/">Gradle</a></li><li class="tag-item"><a class="tag-link" href="/tags/Kotlin/">Kotlin</a></li><li class="tag-item"><a class="tag-link" href="/tags/NAS/">NAS</a></li><li class="tag-item"><a class="tag-link" href="/tags/OpenGL/">OpenGL</a></li><li class="tag-item"><a class="tag-link" href="/tags/React/">React</a></li><li class="tag-item"><a class="tag-link" href="/tags/ReactNative/">ReactNative</a></li><li class="tag-item"><a class="tag-link" href="/tags/Robot/">Robot</a></li><li class="tag-item"><a class="tag-link" href="/tags/axure/">axure</a></li><li class="tag-item"><a class="tag-link" href="/tags/docker/">docker</a></li><li class="tag-item"><a class="tag-link" href="/tags/electron/">electron</a></li><li class="tag-item"><a class="tag-link" href="/tags/hexo/">hexo</a></li><li class="tag-item"><a class="tag-link" href="/tags/jenkins/">jenkins</a></li><li class="tag-item"><a class="tag-link" href="/tags/leetcode/">leetcode</a></li><li class="tag-item"><a class="tag-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-item"><a class="tag-link" href="/tags/python/">python</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F/">开发模式</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%94%B6%E8%97%8F/">收藏</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%AE%97%E6%B3%95/">算法</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">自动化测试</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="footer_wrap"><div class="footer_background"><div class="clouds"></div><div class="background"></div><div class="foreground"></div></div><div class="footer_content"><div><span class="face">ღゝ◡╹)ノ♡</span></div><div>"【人生若只如初见，何事秋风悲画扇】"</div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/handsomeliuyang" target="_blank">刘阳</a> <a href="mailto:40610243@qq.com">40610243@qq.com</a></p><ul class="footer__social-network clearfix"></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script type="text/javascript" src="/js/common/utils.js"></script><script type="text/javascript" src="/js/common/pack.js"></script><script type="text/javascript" src="/js/common/animation.js"></script><script type="text/javascript" src="/js/layout/loading.js"></script><script type="text/javascript" src="/js/layout/header.js"></script><script type="text/javascript" src="/js/layout/back-top.js"></script><script type="text/javascript" src="/js/layout/post.js"></script><script src="/js/page/post.js"></script></body></html>