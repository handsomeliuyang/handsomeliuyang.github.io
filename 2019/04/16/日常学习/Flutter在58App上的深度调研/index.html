<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Flutter在58App上的深度调研 | LiuYang's blog</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="前端, 程序员, Android, Flutter, Kotlin, 全栈开发, node.js, javascript"><meta name="description" content="经验总结和日常学习的个人博客。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://handsomeliuyang.github.io/2019/04/16/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/Flutter%E5%9C%A858App%E4%B8%8A%E7%9A%84%E6%B7%B1%E5%BA%A6%E8%B0%83%E7%A0%94/index.html"><link rel="icon" type="image/png" href="/hexo-img/favicon.png" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="刘阳" type="application/atom+xml"><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/hexo-img/loading.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="刘阳" alt="刘阳"><img src="/hexo-img/favicon.png" alt="刘阳"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/hexo-img/default_cover.png" alt="Flutter在58App上的深度调研"></div><header class="post__info"><h1 class="post__title">Flutter在58App上的深度调研</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a target="_blank" rel="noopener" href="https://github.com/handsomeliuyang">liuyang</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2019-04-16</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Android/">Android</a></li><li class="mark__item"><a href="/tags/Flutter/">Flutter</a></li></ul></div></div></header><div class="post__content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>现在跨平台的框架主要有如下几种：</p><ol><li>ReactNative，Weex</li><li>kotlin-native</li><li>Flutter</li><li>小程序</li><li>Hybrid</li></ol><p>长期来看，跨平台开发一定会是一个趋势，因为其能带来如下好处：</p><ol><li>减少开发成本，提升开发效率</li><li>动态部署，不依赖发版</li></ol><p>但现阶段，框架很多，各有各的优缺点，对于应用开发的RD来说，面临一个框架如何选择的难题。在行业趋势没有真正出现之前，RD应该要勇于去学习，去尝试新框架，学习其设计思想，体验其优势与劣势，找到最适合自己的框架。</p><p>之前对Flutter做过简单应用的尝试（<a href="https://handsomeliuyang.github.io/2018/10/30/Flutter%E5%AE%9E%E7%8E%B0Git%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%B7%A5%E5%85%B7%E4%B9%8B%E6%97%85/">Flutter实现Git权限分配工具之旅</a>），但不够深入，任何一个框架在没有真正进行深入实践时，根本无法判断其优缺点，为了不浮于表面，人云亦云的去判定Flutter框架，才有了这次的调研：基于Flutter实现58App的首页功能（首页模块是58App相对比较复杂的模块）</p><h1 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h1><h2 id="首页tab框架"><a href="#首页tab框架" class="headerlink" title="首页tab框架"></a>首页tab框架</h2><p><strong>实现效果</strong></p><iframe height="520" width="100%" src="/2019/04/16/Flutter在58App上的深度调研/首页tab框架.gif" frameborder="0" allowfullscreen></iframe><p>在Flutter的Material Widget里，有BottomNavigationBar和TabBar两个类似的效果，但都无法直接使用，改造成本非常的大，最终选择自定义实现底部栏。</p><h3 id="自定义ImageButton-Widget"><a href="#自定义ImageButton-Widget" class="headerlink" title="自定义ImageButton Widget"></a>自定义ImageButton Widget</h3><p>ImageButton的要求：</p><ol><li>支持图片与文本</li><li>支持两种状态：default，active</li><li>不同状态有不同的图片，不同的文本颜色</li></ol><p>实现思路：</p><ol><li>InkResponse Widget实现处理点击事件</li><li>Column布局</li><li>StatelessWidget，通过props来修改状态</li></ol><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageButton</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">double</span> width;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">double</span> height;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> imageAssetName;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> activeImageAssetName;</span><br><span class="line">    <span class="keyword">final</span> GestureTapCallback onTap;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> text;</span><br><span class="line">    <span class="keyword">final</span> Color textColor;</span><br><span class="line">    <span class="keyword">final</span> Color activeTextColor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">bool</span> isActive;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ImageButton(&#123;Key key,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.width,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.height,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.imageAssetName,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.activeImageAssetName,</span><br><span class="line">        <span class="keyword">this</span>.text,</span><br><span class="line">        <span class="keyword">this</span>.textColor,</span><br><span class="line">        <span class="keyword">this</span>.activeTextColor,</span><br><span class="line">        <span class="keyword">this</span>.onTap,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.isActive</span><br><span class="line">    &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> InkResponse(</span><br><span class="line">            child: Column(</span><br><span class="line">                mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">                children: &lt;Widget&gt;[</span><br><span class="line">                    Image.asset(</span><br><span class="line">                        <span class="keyword">this</span>.isActive ? <span class="keyword">this</span>.activeImageAssetName : <span class="keyword">this</span>.imageAssetName,</span><br><span class="line">                        width: width,</span><br><span class="line">                        height: height,</span><br><span class="line">                        fit: BoxFit.contain</span><br><span class="line">                    ),</span><br><span class="line">                    Text(</span><br><span class="line">                        <span class="keyword">this</span>.text,</span><br><span class="line">                        style: TextStyle(color: <span class="keyword">this</span>.isActive ? <span class="keyword">this</span>.activeTextColor : <span class="keyword">this</span>.textColor),</span><br><span class="line">                    )</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">            onTap: onTap,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义HomeBottomNavigationBar-Widget"><a href="#自定义HomeBottomNavigationBar-Widget" class="headerlink" title="自定义HomeBottomNavigationBar Widget"></a>自定义HomeBottomNavigationBar Widget</h3><p>要求：</p><ol><li>tabItem数量为奇数，中间的发布大小凸出来</li><li>能与TabBarView联动</li></ol><p>实现思路：</p><ol><li>Container Widget设置高度，背景</li><li>Row，Expanded做等分</li><li>Padding设置每个tabItem的paddingTop</li><li>通过TabController实现与TabBarView联动<ol start="5"><li>tabController 继承 ChangeNotifier，ChangeNotifier是用于通知观察机制</li><li>_controller.addListener()来监听TabBarView的切换</li><li>_controller.animateTo(i)来通知tab的切换</li></ol></li></ol><p>代码如下：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_gallery/wuba_demo/home/publish/publish_home.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../wuba_ui/button/image_button.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NavigationItem</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> icon;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> activeIcon;</span><br><span class="line"></span><br><span class="line">    NavigationItem(&#123;</span><br><span class="line">        <span class="keyword">this</span>.title,</span><br><span class="line">        <span class="keyword">this</span>.icon,</span><br><span class="line">        <span class="keyword">this</span>.activeIcon</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeBottomNavigationBar</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;NavigationItem&gt; items;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> onTap;</span><br><span class="line">    <span class="keyword">final</span> TabController controller;</span><br><span class="line">    <span class="keyword">final</span> Color defaultColor;</span><br><span class="line">    <span class="keyword">final</span> Color selectColor;</span><br><span class="line"></span><br><span class="line">    HomeBottomNavigationBar(&#123;</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.items,</span><br><span class="line">        <span class="keyword">this</span>.onTap,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.controller,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.defaultColor,</span><br><span class="line">        <span class="meta">@required</span> <span class="keyword">this</span>.selectColor</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    _HomeBottomNavigationBarState createState() =&gt; _HomeBottomNavigationBarState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_HomeBottomNavigationBarState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">HomeBottomNavigationBar</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> _currentIndex;</span><br><span class="line">    TabController _controller;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> initState() &#123;</span><br><span class="line">        <span class="keyword">super</span>.initState();</span><br><span class="line">        _updateTabController();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> didUpdateWidget(HomeBottomNavigationBar oldWidget) &#123;</span><br><span class="line">        <span class="keyword">super</span>.didUpdateWidget(oldWidget);</span><br><span class="line">        _updateTabController();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">        <span class="keyword">if</span> (_controller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            _controller.removeListener(_handleTabControllerTick);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.dispose();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> _handleTabControllerTick() &#123;</span><br><span class="line">        debugPrint(<span class="string">&#x27;_handleTabControllerTick <span class="subst">$&#123;_controller.index&#125;</span>&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>._currentIndex != _controller.index) &#123;</span><br><span class="line">            setState(() &#123;</span><br><span class="line">                <span class="keyword">this</span>._currentIndex = _controller.index;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> _updateTabController() &#123;</span><br><span class="line">        <span class="keyword">if</span> (widget.controller == _controller) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 移除老的controller的listener</span></span><br><span class="line">        <span class="keyword">if</span> (_controller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            _controller.removeListener(_handleTabControllerTick);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _controller = widget.controller;</span><br><span class="line">        <span class="keyword">if</span> (_controller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            _controller.addListener(_handleTabControllerTick);</span><br><span class="line">            _currentIndex = _controller.index;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">var</span> children = &lt;Widget&gt;[];</span><br><span class="line">        <span class="comment">// 添加正常的tab选项</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; widget.items.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> navigationItem = widget.items[i];</span><br><span class="line">            children.add(Expanded(</span><br><span class="line">                flex: <span class="number">1</span>,</span><br><span class="line">                child: Padding(</span><br><span class="line">                    padding: EdgeInsets.only(top: <span class="number">15</span>),</span><br><span class="line">                    child: ImageButton(</span><br><span class="line">                        width: <span class="number">23</span>,</span><br><span class="line">                        height: <span class="number">23</span>,</span><br><span class="line">                        imageAssetName: navigationItem.icon,</span><br><span class="line">                        activeImageAssetName: navigationItem.activeIcon,</span><br><span class="line">                        text: navigationItem.title,</span><br><span class="line">                        textColor: widget.defaultColor,</span><br><span class="line">                        activeTextColor: widget.selectColor,</span><br><span class="line">                        isActive: <span class="keyword">this</span>._currentIndex == i,</span><br><span class="line">                        onTap:  () &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">this</span>._controller != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">this</span>._controller.animateTo(i);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (widget.onTap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                widget.onTap(i);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                    ),</span><br><span class="line">                )</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加发布item</span></span><br><span class="line">        children.insert(<span class="number">2</span>, Expanded(</span><br><span class="line">            flex: <span class="number">1</span>,</span><br><span class="line">            child: ImageButton(</span><br><span class="line">                width: <span class="number">40</span>,</span><br><span class="line">                height: <span class="number">40</span>,</span><br><span class="line">                imageAssetName: <span class="string">&#x27;assets/images/home/wb_home_tab_publish_img.png&#x27;</span>,</span><br><span class="line">                activeImageAssetName: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                text: <span class="string">&#x27;发布&#x27;</span>,</span><br><span class="line">                textColor: widget.defaultColor,</span><br><span class="line">                isActive: <span class="keyword">false</span>,</span><br><span class="line">                onTap: ()&#123;</span><br><span class="line">                    Navigator.push(context, PageRouteBuilder(</span><br><span class="line">                        transitionDuration: <span class="built_in">Duration</span>(),</span><br><span class="line">                        pageBuilder: (BuildContext context, Animation&lt;<span class="built_in">double</span>&gt; animation, Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation)&#123;</span><br><span class="line">                            <span class="keyword">return</span> PublishHome();</span><br><span class="line">                        &#125;</span><br><span class="line">                    ));</span><br><span class="line">                &#125;,</span><br><span class="line">            ),</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Container(</span><br><span class="line">            height: <span class="number">63</span>,</span><br><span class="line">            decoration: BoxDecoration(</span><br><span class="line">                image: DecorationImage(</span><br><span class="line">                    image: AssetImage(<span class="string">&#x27;assets/images/home/wb_tab_bg.png&#x27;</span>),</span><br><span class="line">                    fit: BoxFit.fill</span><br><span class="line">                )</span><br><span class="line">            ),</span><br><span class="line">            child: Row(</span><br><span class="line">                crossAxisAlignment: CrossAxisAlignment.stretch,</span><br><span class="line">                children: children,</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="首页tab"><a href="#首页tab" class="headerlink" title="首页tab"></a>首页tab</h3><p>实现思路：</p><ol><li>Stack Positioned实现叠层布局，解决tabbar凸起部份覆盖在TabBarView上</li><li>TabBarView Widget实现类似ViewPager效果</li></ol><p>代码如下：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;home_bottom_navigation_bar.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:wubarn_plugin/wuba_rn_view.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeDemo</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> routeName = <span class="string">&#x27;/wuba/home&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> HomeDemo(&#123; Key key &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    _HomeDemoState createState() =&gt; _HomeDemoState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_HomeDemoState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">HomeDemo</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">List</span>&lt;NavigationItem&gt; _navigationViews;</span><br><span class="line">    TabController controller;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> initState() &#123;</span><br><span class="line">        <span class="keyword">super</span>.initState();</span><br><span class="line"></span><br><span class="line">        _navigationViews = &lt;NavigationItem&gt;[</span><br><span class="line">            NavigationItem(</span><br><span class="line">                icon: <span class="string">&#x27;assets/images/home/wb_home_tap_index_normal.png&#x27;</span>,</span><br><span class="line">                activeIcon: <span class="string">&#x27;assets/images/home/wb_home_tap_index_pressed.png&#x27;</span>,</span><br><span class="line">                title: <span class="string">&#x27;首页&#x27;</span>,</span><br><span class="line">            ),</span><br><span class="line">            NavigationItem(</span><br><span class="line">                icon: <span class="string">&#x27;assets/images/home/wb_home_tap_history_normal.png&#x27;</span>,</span><br><span class="line">                activeIcon: <span class="string">&#x27;assets/images/home/wb_home_tap_history_pressed.png&#x27;</span>,</span><br><span class="line">                title: <span class="string">&#x27;部落&#x27;</span>,</span><br><span class="line">            ),</span><br><span class="line">            NavigationItem(</span><br><span class="line">                icon: <span class="string">&#x27;assets/images/home/wb_home_tap_message_normal.png&#x27;</span>,</span><br><span class="line">                activeIcon: <span class="string">&#x27;assets/images/home/wb_home_tap_message_pressed.png&#x27;</span>,</span><br><span class="line">                title: <span class="string">&#x27;消息&#x27;</span>,</span><br><span class="line">            ),</span><br><span class="line">            NavigationItem(</span><br><span class="line">                icon: <span class="string">&#x27;assets/images/home/wb_home_tap_center_normal.png&#x27;</span>,</span><br><span class="line">                activeIcon: <span class="string">&#x27;assets/images/home/wb_home_tap_center_pressed.png&#x27;</span>,</span><br><span class="line">                title: <span class="string">&#x27;我的&#x27;</span>,</span><br><span class="line">            )</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        controller = TabController(</span><br><span class="line">            initialIndex: <span class="number">2</span>, length: <span class="keyword">this</span>._navigationViews.length, vsync: <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> Scaffold(</span><br><span class="line">            body: Stack(</span><br><span class="line">                children: &lt;Widget&gt;[</span><br><span class="line">                    Positioned(</span><br><span class="line">                        top: <span class="number">0</span>,</span><br><span class="line">                        left: <span class="number">0</span>,</span><br><span class="line">                        right: <span class="number">0</span>,</span><br><span class="line">                        bottom: <span class="number">50</span>,</span><br><span class="line">                        child: TabBarView(</span><br><span class="line">                            controller: controller,</span><br><span class="line">                            children: &lt;Widget&gt;[</span><br><span class="line">                                Container(</span><br><span class="line">                                    color: Colors.red,</span><br><span class="line">                                    child: Text(<span class="string">&#x27;Fragment&#x27;</span>),</span><br><span class="line">                                ),</span><br><span class="line">                                Container(</span><br><span class="line">                                    child: WubaRNView(),</span><br><span class="line">                                ),</span><br><span class="line">                                Container(</span><br><span class="line">                                    color: Colors.white,</span><br><span class="line">                                    child: Text(<span class="string">&#x27;Fragment&#x27;</span>),</span><br><span class="line">                                ),</span><br><span class="line">                                Container(</span><br><span class="line">                                    color: Colors.yellow,</span><br><span class="line">                                    child: Text(<span class="string">&#x27;Fragment&#x27;</span>),</span><br><span class="line">                                )</span><br><span class="line">                            ]</span><br><span class="line">                        ),</span><br><span class="line">                    ),</span><br><span class="line">                    Positioned(</span><br><span class="line">                        left: <span class="number">0</span>,</span><br><span class="line">                        right: <span class="number">0</span>,</span><br><span class="line">                        bottom: <span class="number">0</span>,</span><br><span class="line">                        height: <span class="number">63</span>,</span><br><span class="line">                        child: HomeBottomNavigationBar(</span><br><span class="line">                            items: <span class="keyword">this</span>._navigationViews,</span><br><span class="line">                            controller: <span class="keyword">this</span>.controller,</span><br><span class="line">                            defaultColor: Colors.black,</span><br><span class="line">                            selectColor: Colors.red,</span><br><span class="line">                        ),</span><br><span class="line">                    )</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="内嵌ReactNative"><a href="#内嵌ReactNative" class="headerlink" title="内嵌ReactNative"></a>内嵌ReactNative</h3><p>实现思路：</p><ol><li>通过独立的Flutter Plugin实现</li><li>ReactNative的ReactRootView可以被嵌入Native中，那同样可以被嵌入Flutter中</li><li>Flutter的AndroidView只有两个状态：create，dispose。在这两个状态里，执行ReactNative相关的生命周期函数</li></ol><p>dart部分：创建对应的Widget</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WubaRNView</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    _WubaRNViewState createState() =&gt; _WubaRNViewState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_WubaRNViewState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">WubaRNView</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="comment">// 不同的端，其通信方式不一样</span></span><br><span class="line">        <span class="keyword">if</span> (defaultTargetPlatform == TargetPlatform.android) &#123;</span><br><span class="line">            <span class="keyword">return</span> AndroidView(</span><br><span class="line">                viewType: <span class="string">&#x27;plugins.wuba.com/wubarnview&#x27;</span>,</span><br><span class="line">                onPlatformViewCreated: _onPlatformViewCreated,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Text(</span><br><span class="line">            <span class="string">&#x27;<span class="subst">$defaultTargetPlatform</span> is not yet supported by the WubaRNView plugin&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> _onPlatformViewCreated(<span class="built_in">int</span> id) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Android的实现：</p><ol><li>注册ViewFactory<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WubarnPlugin</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VIEW_TYPE</span> <span class="operator">=</span> <span class="string">&quot;plugins.wuba.com/wubarnview&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Plugin registration. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerWith</span><span class="params">(Registrar registrar)</span> &#123;</span><br><span class="line">        registrar.platformViewRegistry().registerViewFactory(VIEW_TYPE, <span class="keyword">new</span> <span class="title class_">WubarnViewFactory</span>(registrar.messenger()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>通过ViewFactory创建WubarnView<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WubarnViewFactory</span> <span class="keyword">extends</span> <span class="title class_">PlatformViewFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BinaryMessenger messenger;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WubarnViewFactory</span><span class="params">(BinaryMessenger messenger)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(StandardMessageCodec.INSTANCE);</span><br><span class="line">        <span class="built_in">this</span>.messenger = messenger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PlatformView <span class="title function_">create</span><span class="params">(Context context, <span class="type">int</span> id, Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WubarnView</span>(context, messenger, id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>WubarnView的具体实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WubarnView</span> <span class="keyword">implements</span> <span class="title class_">PlatformView</span>, MethodChannel.MethodCallHandler&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactRootView mReactRootView;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactInstanceManager mReactInstanceManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WubarnView</span><span class="params">(Context context, BinaryMessenger messenger, <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="type">MethodChannel</span> <span class="variable">methodChannel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodChannel</span>(messenger, WubarnPlugin.VIEW_TYPE + <span class="string">&quot;_&quot;</span> + id);</span><br><span class="line">        methodChannel.setMethodCallHandler(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// ReactNative的创建及初始化，设置其默认加载的bundle名称</span></span><br><span class="line">        mReactRootView = <span class="keyword">new</span> <span class="title class_">ReactRootView</span>(context);</span><br><span class="line">        mReactInstanceManager = ReactInstanceManager.builder()</span><br><span class="line">                .setApplication((Application) context.getApplicationContext())</span><br><span class="line">                .setBundleAssetName(<span class="string">&quot;index.android.bundle&quot;</span>)</span><br><span class="line">                .setJSMainModulePath(<span class="string">&quot;index&quot;</span>)</span><br><span class="line">                .addPackage(<span class="keyword">new</span> <span class="title class_">MainReactPackage</span>())</span><br><span class="line">                .setUseDeveloperSupport(<span class="literal">false</span>)</span><br><span class="line">                .setInitialLifecycleState(LifecycleState.RESUMED)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">// 这个&quot;App1&quot;名字一定要和我们在index.js中注册的名字保持一致AppRegistry.registerComponent()</span></span><br><span class="line">        mReactRootView.startReactApplication(mReactInstanceManager, <span class="string">&quot;App1&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mReactRootView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// mReactInstanceManager.onHostPause(mActivity);</span></span><br><span class="line">        <span class="comment">// mReactInstanceManager.onHostResume(mActivity, null);</span></span><br><span class="line">        <span class="comment">// mReactInstanceManager.onHostDestroy(mActivity);</span></span><br><span class="line">        mReactRootView.unmountReactApplication();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMethodCall</span><span class="params">(MethodCall methodCall, MethodChannel.Result result)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (methodCall.method)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                result.notImplemented();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>上面初始化ReactInstanceManager当中的常量，与React代码是一一对应的<ol><li>“App1”：与在React里注册的组件名称是一样的<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppRegistry</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">AppRegistry</span>.<span class="title function_">registerComponent</span>(<span class="string">&#x27;App1&#x27;</span>, <span class="function">() =&gt;</span> <span class="title class_">App</span>);</span><br></pre></td></tr></table></figure></li><li>.setJSMainModulePath(“index”)：JS bundle中主入口的文件名，是React工程里的入口文件index.js的名称</li><li>.setBundleAssetName(“index.android.bundle”)：这个是内置到assets目录下的bundle名称，与bundle生成命令有关<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native bundle --platform android --dev false --entry-file index.js --bundle-output /Users/ly/liuyang/workspace_flutter/wubarn_plugin/example/android/app/src/main/assets/index.android.bundle --assets-dest /Users/ly/liuyang/workspace_flutter/wubarn_plugin/example/android/app/src/main/res/</span><br></pre></td></tr></table></figure></li></ol></li></ol><h2 id="发布入口页"><a href="#发布入口页" class="headerlink" title="发布入口页"></a>发布入口页</h2><p><strong>实现效果</strong></p><iframe height="520" width="100%" src="/2019/04/16/Flutter在58App上的深度调研/发布入口页.gif" frameborder="0" allowfullscreen></iframe><h3 id="切换效果"><a href="#切换效果" class="headerlink" title="切换效果"></a>切换效果</h3><p>实现思路：</p><ol><li>通过PageRoute，去掉切换的动画</li><li>通过AnimatedBuilder，实现旋转动画</li><li>通过WillPopScope Widget拦截返回事件</li></ol><p>Flutter的页面切换是由Navigator管理，其中有一个栈，栈帧是路由，通过PageRoute可以自定义切换的动画，如下去掉切换动画的代码：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Navigator.push(context, PageRouteBuilder(</span><br><span class="line">    transitionDuration: <span class="built_in">Duration</span>(), <span class="comment">// 去掉了执行动画的时间</span></span><br><span class="line">    pageBuilder: (BuildContext context, Animation&lt;<span class="built_in">double</span>&gt; animation, Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation)&#123;</span><br><span class="line">        <span class="keyword">return</span> PublishHome();</span><br><span class="line">    &#125;</span><br><span class="line">));</span><br></pre></td></tr></table></figure><p>由于Flutter是MVVM框架，Flutter里的Animation只负责计算，不负责界面布局与渲染，需要手动调用setState()来让界面重绘，不过可以通过AnimatedBuilder简化流程，但Flutter在实现组合动画比较麻烦。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishHome</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    _PublishHomeState createState() =&gt; _PublishHomeState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_PublishHomeState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">PublishHome</span>&gt; <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Animation&lt;<span class="built_in">double</span>&gt; animation;</span><br><span class="line">    AnimationController controller;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> initState() &#123;</span><br><span class="line">        <span class="keyword">super</span>.initState();</span><br><span class="line"></span><br><span class="line">        controller = AnimationController(duration: <span class="built_in">Duration</span>(milliseconds: <span class="number">200</span>), vsync: <span class="keyword">this</span>);</span><br><span class="line">        animation = Tween(begin: <span class="number">0.0</span>, end: <span class="number">45.0</span>).animate(controller);</span><br><span class="line">        animation.addStatusListener((AnimationStatus status)&#123;</span><br><span class="line">            <span class="keyword">if</span>(status == AnimationStatus.dismissed) &#123;</span><br><span class="line">                Navigator.pop(context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        controller.forward();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> WillPopScope(</span><br><span class="line">            onWillPop: () <span class="keyword">async</span> &#123;</span><br><span class="line">                controller.reverse();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            child: Scaffold(</span><br><span class="line">                backgroundColor: Colors.white,</span><br><span class="line">                body: SafeArea(</span><br><span class="line">                    top: <span class="keyword">true</span>,</span><br><span class="line">                    child: Stack(</span><br><span class="line">                        children: &lt;Widget&gt;[</span><br><span class="line">                            ...</span><br><span class="line">                            Positioned(</span><br><span class="line">                                left: <span class="number">0</span>,</span><br><span class="line">                                right: <span class="number">0</span>,</span><br><span class="line">                                bottom: <span class="number">0</span>,</span><br><span class="line">                                height: <span class="number">63</span>,</span><br><span class="line">                                child: GestureDetector(</span><br><span class="line">                                    child: Column(</span><br><span class="line">                                        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">                                        children: &lt;Widget&gt;[</span><br><span class="line">                                            AnimatedBuilder(</span><br><span class="line">                                                animation: <span class="keyword">this</span>.animation,</span><br><span class="line">                                                builder: (BuildContext context, Widget child)&#123;</span><br><span class="line">                                                    <span class="keyword">return</span> Transform.rotate(</span><br><span class="line">                                                        angle: animation.value * math.pi / <span class="number">180.0</span>,</span><br><span class="line">                                                        child: child,</span><br><span class="line">                                                    );</span><br><span class="line">                                                &#125;,</span><br><span class="line">                                                child: Image.asset(</span><br><span class="line">                                                    <span class="string">&#x27;assets/images/home/wb_home_tab_publish_img.png&#x27;</span>,</span><br><span class="line">                                                    width: <span class="number">40</span>,</span><br><span class="line">                                                    height: <span class="number">40</span>,</span><br><span class="line">                                                    fit: BoxFit.contain</span><br><span class="line">                                                ),</span><br><span class="line">                                            ),</span><br><span class="line">                                            Text(</span><br><span class="line">                                                <span class="string">&#x27;发布&#x27;</span>,</span><br><span class="line">                                                style: TextStyle(color: Colors.white),</span><br><span class="line">                                            )</span><br><span class="line">                                        ],</span><br><span class="line">                                    ),</span><br><span class="line">                                    onTap: ()&#123;</span><br><span class="line">                                        controller.reverse();</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                ),</span><br><span class="line">                            )</span><br><span class="line">                        ],</span><br><span class="line"></span><br><span class="line">                    ),</span><br><span class="line">                ),</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="渐变按钮"><a href="#渐变按钮" class="headerlink" title="渐变按钮"></a>渐变按钮</h3><p>要求：</p><ol><li>不使用图片实现</li><li>背景支持渐变</li><li>不要点击效果</li></ol><p>Material Widget里的四种Button无法满足按钮要求，第三方渐变按钮也无法完全满足要求，通过Container Widget的decoration自定义此Widget：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GradientButton</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">double</span> width;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">double</span> height;</span><br><span class="line">    <span class="keyword">final</span> Gradient gradient;</span><br><span class="line">    <span class="keyword">final</span> Widget child;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Function</span> onTap;</span><br><span class="line">    <span class="keyword">final</span> BorderRadius shapeRadius;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> GradientButton(</span><br><span class="line">        &#123;Key key, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height, <span class="keyword">this</span>.gradient, <span class="keyword">this</span>.onTap, <span class="keyword">this</span>.shapeRadius, <span class="keyword">this</span>.child&#125;)</span><br><span class="line">        : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> GestureDetector(</span><br><span class="line">            onTap: <span class="keyword">this</span>.onTap,</span><br><span class="line">            child: Container(</span><br><span class="line">                width: <span class="keyword">this</span>.width,</span><br><span class="line">                height: <span class="keyword">this</span>.height,</span><br><span class="line">                decoration: BoxDecoration(</span><br><span class="line">                    gradient: <span class="keyword">this</span>.gradient, <span class="comment">// 设置渐变</span></span><br><span class="line">                    borderRadius: <span class="keyword">this</span>.shapeRadius <span class="comment">// 设置圆角</span></span><br><span class="line">                ),</span><br><span class="line">                child: Center(</span><br><span class="line">                    child: child,</span><br><span class="line">                )</span><br><span class="line">            ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="部落图片选择控件"><a href="#部落图片选择控件" class="headerlink" title="部落图片选择控件"></a>部落图片选择控件</h2><p><strong>实现效果</strong></p><iframe height="520" width="100%" src="/2019/04/16/Flutter在58App上的深度调研/部落图片选择控件.gif" frameborder="0" allowfullscreen></iframe><h3 id="底部抽屉效果"><a href="#底部抽屉效果" class="headerlink" title="底部抽屉效果"></a>底部抽屉效果</h3><p>要求：</p><ol><li>BottomSheet增加中间态</li><li>有回弹效果</li></ol><p>第三方库RubberBottomSheet实现了此效果，其原理如下：</p><ol><li>通过Stack实现叠加布局</li><li>修改AnimationController的原码，依据lowerBound，upperBound的实现思路，实现halfBound，即中间态</li></ol><p>直接使用RubberBottomSheet的代码非常简单：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TribePublish</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    _TribePublishState createState() =&gt; _TribePublishState();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TribePublishState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TribePublish</span>&gt; <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    RubberAnimationController _controller;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> initState() &#123;</span><br><span class="line">        <span class="keyword">super</span>.initState();</span><br><span class="line">        _controller = RubberAnimationController(</span><br><span class="line">            vsync: <span class="keyword">this</span>,</span><br><span class="line">            lowerBoundValue: AnimationControllerValue(pixel: <span class="number">54</span>),</span><br><span class="line">            halfBoundValue: AnimationControllerValue(pixel: <span class="number">300</span>),</span><br><span class="line">            upperBoundValue: AnimationControllerValue(percentage: <span class="number">1.0</span>),</span><br><span class="line">            duration: <span class="built_in">Duration</span>(milliseconds: <span class="number">200</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> Scaffold(</span><br><span class="line">            backgroundColor: Colors.white,</span><br><span class="line">            appBar: AppBar(</span><br><span class="line">                title: Text(<span class="string">&#x27;部落发布&#x27;</span>),</span><br><span class="line">            ),</span><br><span class="line">            body: RubberBottomSheet(</span><br><span class="line">                header: _getHeader(),</span><br><span class="line">                lowerLayer: _getLowerLayer(),</span><br><span class="line">                upperLayer: _getUpperLayer(),</span><br><span class="line">                animationController: _controller,</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="加载并显示相册图片"><a href="#加载并显示相册图片" class="headerlink" title="加载并显示相册图片"></a>加载并显示相册图片</h3><p><strong>加载相册图片</strong></p><ol><li>通过MethodChannel，实现与Native通信，加载相册图片</li><li>在Android里，加载相册图片，需要先授权</li><li>防止相册图片过多，需进行分页加载</li></ol><p>Android端的代码实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlbumManagerPlugin</span> <span class="keyword">implements</span> <span class="title class_">MethodChannel</span>.MethodCallHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerWith</span><span class="params">(PluginRegistry registry)</span> &#123;</span><br><span class="line">        registerWith(registry.registrarFor(<span class="string">&quot;com.wuba.plugins.AlbumManagerPlugin&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerWith</span><span class="params">(PluginRegistry.Registrar registrar)</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MethodChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodChannel</span>(registrar.messenger(), <span class="string">&quot;plugins.wuba.com/album_manager&quot;</span>);</span><br><span class="line">        channel.setMethodCallHandler(<span class="keyword">new</span> <span class="title class_">AlbumManagerPlugin</span>(registrar.context(), registrar));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * the page size of query albums</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PAGE_SIZE</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PluginRegistry.Registrar mRegistrar;</span><br><span class="line">    <span class="keyword">private</span> PermissionsUtils mPermissionsUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AlbumManagerPlugin</span><span class="params">(Context context, PluginRegistry.Registrar registrar)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mContext = context;</span><br><span class="line">        mRegistrar = registrar;</span><br><span class="line">        mPermissionsUtils = <span class="keyword">new</span> <span class="title class_">PermissionsUtils</span>();</span><br><span class="line"></span><br><span class="line">        registrar.addRequestPermissionsResultListener(<span class="keyword">new</span> <span class="title class_">PluginRegistry</span>.RequestPermissionsResultListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onRequestPermissionsResult</span><span class="params">(<span class="type">int</span> i, String[] strings, <span class="type">int</span>[] ints)</span> &#123;</span><br><span class="line">                mPermissionsUtils.dealResult(i, strings, ints);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMethodCall</span><span class="params">(MethodCall methodCall, MethodChannel.Result result)</span> &#123;</span><br><span class="line">        <span class="comment">// 先申请权限</span></span><br><span class="line">        mPermissionsUtils.setPermissionsListener(<span class="keyword">new</span> <span class="title class_">PermissionsListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDenied</span><span class="params">(String[] deniedPermissions)</span> &#123;</span><br><span class="line">                Log.i(<span class="string">&quot;permission&quot;</span>, <span class="string">&quot;onDenied call.method = $&#123;call.method&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">                result.error(<span class="string">&quot;失败&quot;</span>, <span class="string">&quot;权限被拒绝&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGranted</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> (methodCall.method)&#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;getAllImage&quot;</span>:</span><br><span class="line">                        getAllImage(methodCall, result);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        result.notImplemented();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mPermissionsUtils.withActivity(mRegistrar.activity());</span><br><span class="line">        mPermissionsUtils.getPermissions(mRegistrar.activity(), <span class="number">3001</span>, Manifest.permission.READ_EXTERNAL_STORAGE, Manifest.permission.WRITE_EXTERNAL_STORAGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getAllImage</span><span class="params">(MethodCall methodCall, MethodChannel.Result result)</span> &#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        int pageIndex = methodCall.argument(&quot;pageIndex&quot;);</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pageIndex</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">&quot;liuyang&quot;</span>, <span class="string">&quot;&quot;</span> + methodCall.argument(<span class="string">&quot;pageIndex&quot;</span>));</span><br><span class="line"></span><br><span class="line">        String[] projection = &#123;MediaStore.Images.ImageColumns.DATA, MediaStore.Images.ImageColumns.BUCKET_DISPLAY_NAME&#125;;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sortOrder</span> <span class="operator">=</span> MediaStore.Images.Media.DATE_TAKEN + <span class="string">&quot; DESC limit &quot;</span> + PAGE_SIZE + <span class="string">&quot; offset &quot;</span> + pageIndex * PAGE_SIZE;</span><br><span class="line">        <span class="comment">//执行分页</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">selection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//        if (!ALL_PHOTO.equals(s)) &#123;</span></span><br><span class="line"><span class="comment">//            selection = MediaStore.Images.ImageColumns.BUCKET_DISPLAY_NAME + &quot; = &#x27;&quot; + s + &quot;&#x27; &quot;;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> mContext.getContentResolver().query(MediaStore.Images.Media.EXTERNAL_CONTENT_URI,</span><br><span class="line">                projection, selection, <span class="literal">null</span>, sortOrder);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cursor != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (cursor.moveToNext()) &#123;</span><br><span class="line">                    <span class="comment">// 获取图片的路径</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> cursor.getString(cursor.getColumnIndex(MediaStore.Images.ImageColumns.DATA));</span><br><span class="line">                    list.add(path);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                result.success(list);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//            LOGGER.e(TAG, e.toString());</span></span><br><span class="line">            result.error(<span class="string">&quot;AlbumManagerPlugin&quot;</span>, e.getMessage(), <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cursor != <span class="literal">null</span>) &#123;</span><br><span class="line">                cursor.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Flutter端的代码实现：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlbumManagerPlugin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> MethodChannel _channel = MethodChannel(<span class="string">&#x27;plugins.wuba.com/album_manager&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Future&lt;<span class="built_in">List</span>&lt;AssetEntity&gt;&gt; getAllAssetList(<span class="built_in">int</span> pageIndex) <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="built_in">Map</span>&lt;<span class="built_in">dynamic</span>, <span class="built_in">dynamic</span>&gt; map = <span class="built_in">Map</span>&lt;<span class="built_in">dynamic</span>, <span class="built_in">dynamic</span>&gt;();</span><br><span class="line">        map[<span class="string">&#x27;pageIndex&#x27;</span>] = pageIndex;</span><br><span class="line">        <span class="built_in">List</span>&lt;<span class="built_in">dynamic</span>&gt; paths = <span class="keyword">await</span> _channel.invokeMethod(<span class="string">&#x27;getAllImage&#x27;</span>, map);</span><br><span class="line">        <span class="keyword">return</span> _castAsset(paths);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Future&lt;<span class="built_in">List</span>&lt;AssetEntity&gt;&gt; _castAsset(<span class="built_in">List</span>&lt;<span class="built_in">dynamic</span>&gt; paths) <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="built_in">List</span>&lt;AssetEntity&gt; result = &lt;AssetEntity&gt;[];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; paths.length; i++) &#123;</span><br><span class="line">            result.add(AssetEntity(path: paths[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>细节点：</p><ol><li>Native的扩展能力定义为Plugin，Plugin可以独立发布为一个库，里面即有native代码也有dart代码，不用像ReactNative，需要单独合并native的代码，但带的问题是：dependencies库都是直接原码</li><li>通过MethodChannel进行Flutter与Native通信，可以传递参数，如何传递一组参数了，通过源码分析：Map对象</li></ol><p><strong>分页显示图片</strong></p><ol><li>通过GridView显示图片，实现分页加载</li><li>默认的图片加载策略是LRU，体验与内存表现都很不好</li></ol><p>下面的代码没有实现分页与图片加载策略的优化：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlbumGrid</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    _AlbumGridState createState() =&gt; _AlbumGridState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AlbumGridState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">AlbumGrid</span>&gt; </span>&#123;</span><br><span class="line">    <span class="built_in">List</span>&lt;AssetEntity&gt; list = <span class="keyword">new</span> <span class="built_in">List</span>&lt;AssetEntity&gt;();</span><br><span class="line">    <span class="built_in">int</span> currentPage = <span class="number">-1</span>;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> initState() &#123;</span><br><span class="line">        <span class="keyword">super</span>.initState();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载第一页数据</span></span><br><span class="line">        _initData(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> _initData(<span class="built_in">int</span> nextPage) <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="built_in">List</span>&lt;AssetEntity&gt; newPage = <span class="keyword">await</span> AlbumManagerPlugin.getAllAssetList(nextPage);</span><br><span class="line">        <span class="keyword">this</span>.setState(()&#123;</span><br><span class="line">            list.addAll(newPage);</span><br><span class="line">            currentPage = nextPage;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> GridView.builder(</span><br><span class="line">            gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(</span><br><span class="line">                crossAxisCount: <span class="number">4</span>,</span><br><span class="line">                mainAxisSpacing: <span class="number">4.0</span>,</span><br><span class="line">                crossAxisSpacing: <span class="number">4.0</span></span><br><span class="line">            ),</span><br><span class="line">            padding: EdgeInsets.all(<span class="number">4.0</span>),</span><br><span class="line">            itemBuilder: _itemBuilder,</span><br><span class="line">            itemCount: list.length,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    Widget _itemBuilder(BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">        AssetEntity entity = list[index];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Image.file(</span><br><span class="line">            File(entity.path),</span><br><span class="line">            fit: BoxFit.cover,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>Flutter框架在设计上，整体优于其他跨平台框架，实现使用时，也是非常的方便，有如下感受：</p><ol><li>开发调试非常的快，比Android的instant run强很多，也稳定很多</li><li>dependencies依赖管理比ReactNative强，native扩展能力是一个独立的plugin库，便于管理依赖</li><li>基于MVVM框架，在自定义UI组件及动画方面，结构清楚，容易理解</li><li>实现相同的功能，代码量远小于使用java实现</li></ol><p>由于Flutter的社区不太完善，时间太短，生态不完善，相当于2011年开发Android一样，缺少大量成熟的基础库，大量的基础能力都需要从头到尾开发，下面是上述实践过程中发现的一些点：</p><ol><li>渐变Button，图片Button</li><li>GridView或ListView的图片加载策略（Fling时不加载，scrolling或idle时加载）</li><li>崩溃日志收集</li><li>大量的基础Plugin：加载相册，授权，地图，视频等等</li><li>…</li></ol><p>在已经集成ReactNative的58App里，已经基本满足部分业务的动态能力，再花大量的成本完美Flutter的基础，花大量的成本去推动业务线使用，短期来看，投入产出比太低。</p><p>但从长期来看，在跨平台框架上，我更加看好Flutter，在设计与使用体验上，Flutter确实都优于其他框架，但Flutter最终能否成为主流，还是要看Google的推广力度。</p><p>持续关注跨平台框架的动态，ReactNative也在向Flutter学习，改进其性能差的一面，Flutter的基础库也在不断的完善中</p><p>此demo的代码：<a target="_blank" rel="noopener" href="https://github.com/handsomeliuyang/wuba_gallery">wuba_gallery</a></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a target="_blank" rel="noopener" href="http://www.devio.org/2018/08/26/React-Native-Hybrid-Android/">React Native 混合开发(Android篇)</a></li></ol><div class="post-announce">感谢您的阅读，本文由 <a href="https://handsomeliuyang.github.io">刘阳</a> 版权所有。如若转载，请注明出处：刘阳（<a href="https://handsomeliuyang.github.io/2019/04/16/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/Flutter%E5%9C%A858App%E4%B8%8A%E7%9A%84%E6%B7%B1%E5%BA%A6%E8%B0%83%E7%A0%94/">https://handsomeliuyang.github.io/2019/04/16/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/Flutter%E5%9C%A858App%E4%B8%8A%E7%9A%84%E6%B7%B1%E5%BA%A6%E8%B0%83%E7%A0%94/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2019/02/25/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/%E7%99%BE%E5%BA%A6%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" title="百度小程序源码解读"><i class="iconfont icon-prev"></i>百度小程序源码解读</a></div><div class="post__prev post__prev--right"><a href="/2019/04/26/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/LeetCodeLargestNumber/" title="LeetCode Largest Number">LeetCode Largest Number<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">经验总结和日常学习的个人博客。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/">经验总结</a><span class="block-list-count">32</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/">日常学习</a><span class="block-list-count">29</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%96%87%E7%AB%A0%E8%BD%AC%E5%8F%91/">文章转发</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2023/10/08/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/Android%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9AAndroid%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86/" title="Android内核学习笔记：Android进程\线程管理"><div class="item__cover"><img src="/hexo-img/default_cover.png" alt="Android内核学习笔记：Android进程\线程管理"></div><div class="item__info"><h3 class="item__title">Android内核学习笔记：Android进程\线程管理</h3><span class="item__text">2023-10-08</span></div></a></li><li class="latest-post-item"><a href="/2023/08/08/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/ASM%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/" title="ASM 学习心得"><div class="item__cover"><img src="/hexo-img/default_cover.png" alt="ASM 学习心得"></div><div class="item__info"><h3 class="item__title">ASM 学习心得</h3><span class="item__text">2023-08-08</span></div></a></li><li class="latest-post-item"><a href="/2023/02/22/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/App%E7%9A%84Repo%E5%A4%9A%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86/" title="App的Repo多仓库管理"><div class="item__cover"><img src="/hexo-img/default_cover.png" alt="App的Repo多仓库管理"></div><div class="item__info"><h3 class="item__title">App的Repo多仓库管理</h3><span class="item__text">2023-02-22</span></div></a></li><li class="latest-post-item"><a href="/2022/11/02/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/%E4%BB%8E%E5%BC%80%E5%8F%91%E8%80%85%E8%A7%92%E5%BA%A6%E6%80%9D%E8%80%83%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%9A%84%E4%BB%B7%E5%80%BC/" title="从开发者角度思考单元测试的价值"><div class="item__cover"><img src="/hexo-img/default_cover.png" alt="从开发者角度思考单元测试的价值"></div><div class="item__info"><h3 class="item__title">从开发者角度思考单元测试的价值</h3><span class="item__text">2022-11-02</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/AOP/">AOP</a></li><li class="tag-item"><a class="tag-link" href="/tags/ASM/">ASM</a></li><li class="tag-item"><a class="tag-link" href="/tags/Android/">Android</a></li><li class="tag-item"><a class="tag-link" href="/tags/Android%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">Android内核学习笔记</a></li><li class="tag-item"><a class="tag-link" href="/tags/Dart/">Dart</a></li><li class="tag-item"><a class="tag-link" href="/tags/Flutter/">Flutter</a></li><li class="tag-item"><a class="tag-link" href="/tags/Gradle/">Gradle</a></li><li class="tag-item"><a class="tag-link" href="/tags/Kotlin/">Kotlin</a></li><li class="tag-item"><a class="tag-link" href="/tags/NAS/">NAS</a></li><li class="tag-item"><a class="tag-link" href="/tags/OpenGL/">OpenGL</a></li><li class="tag-item"><a class="tag-link" href="/tags/React/">React</a></li><li class="tag-item"><a class="tag-link" href="/tags/ReactNative/">ReactNative</a></li><li class="tag-item"><a class="tag-link" href="/tags/Robot/">Robot</a></li><li class="tag-item"><a class="tag-link" href="/tags/axure/">axure</a></li><li class="tag-item"><a class="tag-link" href="/tags/docker/">docker</a></li><li class="tag-item"><a class="tag-link" href="/tags/electron/">electron</a></li><li class="tag-item"><a class="tag-link" href="/tags/hexo/">hexo</a></li><li class="tag-item"><a class="tag-link" href="/tags/jenkins/">jenkins</a></li><li class="tag-item"><a class="tag-link" href="/tags/leetcode/">leetcode</a></li><li class="tag-item"><a class="tag-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-item"><a class="tag-link" href="/tags/python/">python</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F/">开发模式</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%94%B6%E8%97%8F/">收藏</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%AE%97%E6%B3%95/">算法</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">自动化测试</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="footer_wrap"><div class="footer_background"><div class="clouds"></div><div class="background"></div><div class="foreground"></div></div><div class="footer_content"><div><span class="face">ღゝ◡╹)ノ♡</span></div><div>"【人生若只如初见，何事秋风悲画扇】"</div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/handsomeliuyang" target="_blank">刘阳</a> <a href="mailto:40610243@qq.com">40610243@qq.com</a></p><ul class="footer__social-network clearfix"></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script type="text/javascript" src="/js/common/utils.js"></script><script type="text/javascript" src="/js/common/pack.js"></script><script type="text/javascript" src="/js/common/animation.js"></script><script type="text/javascript" src="/js/layout/loading.js"></script><script type="text/javascript" src="/js/layout/header.js"></script><script type="text/javascript" src="/js/layout/back-top.js"></script><script type="text/javascript" src="/js/layout/post.js"></script><script src="/js/page/post.js"></script></body></html>